<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS Testing Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .header {
            background-color: #3498db;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .service-card {
            background-color: white;
            border-radius: 5px;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        pre {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 10px;
            overflow-x: auto;
            max-height: 300px;
            border: 1px solid #ddd;
        }
        .endpoint-selector {
            margin-bottom: 10px;
        }
        .endpoint-selector label {
            margin-right: 10px;
        }
        .result-container {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>CORS Testing Tool</h1>
        <p>Test CORS configuration for all microservices</p>
    </div>

    <div>
        <h2>Services</h2>
        <div id="services-container">
            <!-- Services will be added here -->
        </div>
    </div>

    <script>
        // Services configuration
        const services = [
            {
                name: 'Auth Service',
                url: 'https://auth-service-production-d5c8.up.railway.app',
                endpoints: [
                    { path: '/health', method: 'GET' },
                    { path: '/api/auth/status', method: 'GET' },
                ]
            },
            {
                name: 'User Service',
                url: 'https://user-service-production-f141.up.railway.app',
                endpoints: [
                    { path: '/health', method: 'GET' },
                    { path: '/api/users/health', method: 'GET' },
                ]
            },
            {
                name: 'Matching Service',
                url: 'https://matching-service-production.up.railway.app',
                endpoints: [
                    { path: '/health', method: 'GET' },
                    { path: '/api/matching/stats', method: 'GET' },
                ]
            },
            {
                name: 'Communication Service',
                url: 'https://communication-service-production-c165.up.railway.app',
                endpoints: [
                    { path: '/health', method: 'GET' },
                    { path: '/api/messages/status', method: 'GET' },
                ]
            },
            {
                name: 'Notification Service',
                url: 'https://notification-service-production-8738.up.railway.app',
                endpoints: [
                    { path: '/health', method: 'GET' },
                    { path: '/api/notifications/status', method: 'GET' },
                ]
            }
        ];

        // Create service cards
        function createServiceCards() {
            const container = document.getElementById('services-container');
            services.forEach(service => {
                const card = document.createElement('div');
                card.className = 'service-card';
                
                const title = document.createElement('h3');
                title.textContent = service.name;
                card.appendChild(title);
                
                const url = document.createElement('p');
                url.innerHTML = `<strong>URL:</strong> ${service.url}`;
                card.appendChild(url);
                
                // Endpoint selector
                const endpointSelector = document.createElement('div');
                endpointSelector.className = 'endpoint-selector';
                endpointSelector.innerHTML = '<strong>Endpoint:</strong> ';
                
                const select = document.createElement('select');
                select.id = `${service.name.replace(/\s+/g, '-').toLowerCase()}-endpoint`;
                service.endpoints.forEach((endpoint, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${endpoint.method} ${endpoint.path}`;
                    select.appendChild(option);
                });
                endpointSelector.appendChild(select);
                card.appendChild(endpointSelector);
                
                // Test buttons
                const buttonsContainer = document.createElement('div');
                
                const testButton = document.createElement('button');
                testButton.textContent = 'Test Request';
                testButton.onclick = () => testCors(service);
                buttonsContainer.appendChild(testButton);
                
                const optionsButton = document.createElement('button');
                optionsButton.textContent = 'Test OPTIONS';
                optionsButton.onclick = () => testCorsOptions(service);
                buttonsContainer.appendChild(optionsButton);
                
                card.appendChild(buttonsContainer);
                
                // Results container
                const resultsContainer = document.createElement('div');
                resultsContainer.className = 'result-container';
                resultsContainer.id = `${service.name.replace(/\s+/g, '-').toLowerCase()}-results`;
                card.appendChild(resultsContainer);
                
                container.appendChild(card);
            });
        }

        // Test CORS for a service
        async function testCors(service) {
            const resultsContainer = document.getElementById(`${service.name.replace(/\s+/g, '-').toLowerCase()}-results`);
            const selectElement = document.getElementById(`${service.name.replace(/\s+/g, '-').toLowerCase()}-endpoint`);
            const selectedEndpoint = service.endpoints[selectElement.value];
            
            resultsContainer.innerHTML = '<p>Testing... please wait</p>';
            
            try {
                const response = await fetch(`${service.url}${selectedEndpoint.path}`, {
                    method: selectedEndpoint.method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                });
                
                const corsHeaders = {
                    'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                    'access-control-allow-credentials': response.headers.get('access-control-allow-credentials'),
                    'access-control-allow-methods': response.headers.get('access-control-allow-methods'),
                    'access-control-allow-headers': response.headers.get('access-control-allow-headers'),
                };
                
                const corsStatus = corsHeaders['access-control-allow-origin'] ? 
                    '<span class="success">✓ CORS Enabled</span>' : 
                    '<span class="error">✗ CORS Not Enabled</span>';
                
                let responseData;
                try {
                    responseData = await response.json();
                } catch (e) {
                    responseData = await response.text();
                }
                
                resultsContainer.innerHTML = `
                    <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                    <p><strong>CORS:</strong> ${corsStatus}</p>
                    <p><strong>CORS Headers:</strong></p>
                    <pre>${JSON.stringify(corsHeaders, null, 2)}</pre>
                    <p><strong>Response:</strong></p>
                    <pre>${typeof responseData === 'object' ? JSON.stringify(responseData, null, 2) : responseData}</pre>
                `;
            } catch (error) {
                resultsContainer.innerHTML = `
                    <p class="error">Error: ${error.message}</p>
                    <p>This might indicate a CORS issue blocking the request.</p>
                `;
            }
        }

        // Test OPTIONS request (preflight)
        async function testCorsOptions(service) {
            const resultsContainer = document.getElementById(`${service.name.replace(/\s+/g, '-').toLowerCase()}-results`);
            const selectElement = document.getElementById(`${service.name.replace(/\s+/g, '-').toLowerCase()}-endpoint`);
            const selectedEndpoint = service.endpoints[selectElement.value];
            
            resultsContainer.innerHTML = '<p>Testing OPTIONS request... please wait</p>';
            
            try {
                const response = await fetch(`${service.url}${selectedEndpoint.path}`, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type,Authorization',
                        'Origin': window.location.origin
                    }
                });
                
                const corsHeaders = {
                    'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                    'access-control-allow-credentials': response.headers.get('access-control-allow-credentials'),
                    'access-control-allow-methods': response.headers.get('access-control-allow-methods'),
                    'access-control-allow-headers': response.headers.get('access-control-allow-headers'),
                };
                
                const corsStatus = corsHeaders['access-control-allow-origin'] ? 
                    '<span class="success">✓ CORS Preflight Enabled</span>' : 
                    '<span class="error">✗ CORS Preflight Not Enabled</span>';
                
                resultsContainer.innerHTML = `
                    <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                    <p><strong>CORS Preflight:</strong> ${corsStatus}</p>
                    <p><strong>CORS Headers:</strong></p>
                    <pre>${JSON.stringify(corsHeaders, null, 2)}</pre>
                `;
            } catch (error) {
                resultsContainer.innerHTML = `
                    <p class="error">Error: ${error.message}</p>
                    <p>This might indicate a CORS issue blocking the preflight request.</p>
                `;
            }
        }

        // Initialize
        createServiceCards();
    </script>
</body>
</html>